# name: ğŸ” Trivy Scan

# on:
#   workflow_call:
#     inputs:
#       image:
#         required: true
#         type: string

# jobs:
#   scan:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/cache@v4
#         with:
#           path: ~/.cache/trivy
#           key: trivy-db-${{ runner.os }}

#       - name: ğŸ› ï¸ Install Trivy
#         run: |
#           sudo apt-get update
#           sudo apt-get install -y wget apt-transport-https gnupg lsb-release
#           wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg
#           echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/trivy.list
#           sudo apt-get update
#           sudo apt-get install -y trivy

#       - name: ğŸ” Scan Docker Image
#         run: |
#           trivy image --exit-code 1 --severity HIGH,CRITICAL ${{ inputs.image }}




name: ğŸ” Trivy Scan

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string

jobs:
  trivy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ“¥ Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: ğŸ“¦ Load Docker Images
        run: |
          docker load -i image_latest.tar || true
          docker load -i image_versioned.tar || true

      - name: ğŸ› ï¸ Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: ğŸ” Trivy Scan
        run: |
          trivy image --exit-code 1 --severity HIGH,CRITICAL ${{ inputs.image }}
