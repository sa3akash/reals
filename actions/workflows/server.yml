name: ğŸ§± Build & Scan Server Image

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: sa2avroo/testing-server

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v3

    - name: ğŸ§° Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: ğŸ“¦ Install Server Deps
      working-directory: ./server
      run: npm install --legacy-peer-deps

    - name: ğŸ§¹ Lint
      working-directory: ./server
      run: npm run lint || true

    - name: ğŸ§ª Run Tests
      working-directory: ./server
      run: npm run test || true

    - name: ğŸ·ï¸ Get Version from Tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: ğŸ” Docker Login
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: ğŸ³ Build Server Docker Image
      run: |
        docker build -t ${IMAGE_NAME}:latest ./server
        docker tag ${IMAGE_NAME}:latest ${IMAGE_NAME}:${{ steps.get_version.outputs.VERSION }}

    - name: ğŸ” Trivy Scan (latest)
      uses: ./.github/workflows/trivy-scan.yml
      with:
        image: sa2avroo/testing-server:latest

    - name: ğŸ” Trivy Scan (versioned)
      uses: ./.github/workflows/trivy-scan.yml
      with:
        image: sa2avroo/testing-server:${{ steps.get_version.outputs.VERSION }}

    - name: ğŸš€ Push Server Images
      run: |
        docker push ${IMAGE_NAME}:latest
        docker push ${IMAGE_NAME}:${{ steps.get_version.outputs.VERSION }}


# git tag v1.2.3
# git push origin v1.2.3 --tags